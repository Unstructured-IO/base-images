name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  set-short-sha:
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.set_short_sha.outputs.short_sha }}
    steps:
      - name: Set Short SHA
        id: set_short_sha
        run: echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
  build-images:
    strategy:
      matrix:
        docker-platform: ["linux/arm64", "linux/amd64"]
        images: ["rocky9.2-1"]
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Login to Quay.io
          uses: docker/login-action@v2
          with:
            registry: quay.io
            username: ${{ secrets.QUAY_IO_ROBOT_USERNAME }}
            password: ${{ secrets.QUAY_IO_ROBOT_TOKEN }}
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v2
        - name: Build base images
          run: |
            make build-base-images
          env:
            DOCKER_PLATFORM: ${{ matrix.docker-platform }}
            DOCKERFILE: ${{ matrix.image }}
            CI: "true"
            SHORT_SHA: ${{ needs.set-short-sha.outputs.short_sha }}

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
